generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum BeaconType {
  NORMAL
  URGENT
}

enum BeaconStatus {
  OPEN
  IN_SESSION
  CLOSED
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())

  profile Profile?

  beacons      Beacon[]            @relation("UserBeacons")
  applications BeaconApplication[]

  sessionsAsLearner Session[] @relation("LearnerSessions")
  sessionsAsHelper  Session[] @relation("HelperSessions")

  ratingsGiven    Rating[] @relation("RatingsGiven")
  ratingsReceived Rating[] @relation("RatingsReceived")

  helperStats HelperStats?
}

model Profile {
  id     String @id @default(uuid())
  userId String @unique

  name      String
  bio       String?
  interests String[]
  skills    String[]

  user User @relation(fields: [userId], references: [id])
}

model Beacon {
  id          String @id @default(uuid())
  title       String
  description String

  type   BeaconType
  status BeaconStatus @default(OPEN)

  createdAt DateTime  @default(now())
  expiresAt DateTime?

  creatorId String
  creator   User   @relation("UserBeacons", fields: [creatorId], references: [id])

  applications BeaconApplication[]
  session      Session?

  @@index([status])
  @@index([type])
}

model BeaconApplication {
  id       String @id @default(uuid())
  beaconId String
  helperId String

  appliedAt DateTime @default(now())
  message   String?

  beacon Beacon @relation(fields: [beaconId], references: [id])
  helper User   @relation(fields: [helperId], references: [id])

  @@unique([beaconId, helperId])
  @@index([beaconId])
}

model Session {
  id String @id @default(uuid())

  beaconId  String @unique
  learnerId String
  helperId  String

  status SessionStatus @default(ACTIVE)

  startedAt DateTime  @default(now())
  endedAt   DateTime?

  beacon  Beacon @relation(fields: [beaconId], references: [id])
  learner User   @relation("LearnerSessions", fields: [learnerId], references: [id])
  helper  User   @relation("HelperSessions", fields: [helperId], references: [id])

  ratings Rating[]

  @@index([learnerId])
  @@index([helperId])
}

model Rating {
  id String @id @default(uuid())

  sessionId  String
  fromUserId String
  toUserId   String

  score   Int
  comment String?

  createdAt DateTime @default(now())

  session  Session @relation(fields: [sessionId], references: [id])
  fromUser User    @relation("RatingsGiven", fields: [fromUserId], references: [id])
  toUser   User    @relation("RatingsReceived", fields: [toUserId], references: [id])

  @@unique([sessionId, fromUserId])
  @@index([toUserId])
}

model HelperStats {
  id     String @id @default(uuid())
  userId String @unique

  helpCount   Int   @default(0)
  totalPoints Int   @default(0)
  avgRating   Float @default(0)

  user User @relation(fields: [userId], references: [id])
}
